import { Note } from '../model/Note';
import { Comment } from '../model/Comment';
import { HomeViewModel } from '../viewmodel/HomeViewModel';

@Component
export struct NoteDetailPage {
  @Link visible: boolean;
  @Prop note: Note;
  @Prop vm?: HomeViewModel;
  @Link followVersion: number;
  @State currentNote: Note = {} as Note;
  @State comments: Comment[] = [];
  @State commentInput: string = '';
  @State showComments: boolean = true;

  aboutToAppear() {
    this.updateNoteData();
  }

  private updateNoteData() {
    // ‰ªéViewModelËé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
    if (this.vm) {
      const latestNote = this.vm.getNote(this.note.id);
      this.currentNote = latestNote || this.note;
      this.comments = this.vm.getComments(this.note.id);
    } else {
      this.currentNote = this.note;
      this.comments = [];
    }
  }

  build() {
    Column() {
      Scroll() {
        Column() {
          // È°∂ÈÉ®Ê†èÔºöËøîÂõû + Â§¥ÂÉè + ÊòµÁß∞ + ÂÖ≥Ê≥® + ÂàÜ‰∫´
          Row() {
            Text('‚Üê')
              .fontSize(20)
              .padding(8)
              .onClick(() => {
                this.visible = false;
              })

            Image(this.getAvatarResource(this.currentNote.authorAvatarIndex ?? 1))
              .width(36)
              .height(36)
              .borderRadius(18)
              .objectFit(ImageFit.Cover)
              .margin({ left: 4 })

            Text(this.currentNote.author ?? 'Áî®Êà∑')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .margin({ left: 10 })

            Blank()

            // ÂÖ≥Ê≥®ÊåâÈíÆ
            Text(this.vm && this.currentNote.authorId && this.vm.isFollowing(this.currentNote.authorId) ? 'Â∑≤ÂÖ≥Ê≥®' :
              'ÂÖ≥Ê≥®')
              .fontSize(14)
              .fontColor('#ff4d4f')
              .padding({
                left: 16,
                right: 16,
                top: 8,
                bottom: 8
              })
              .borderRadius(18)
              .border({ width: 1, color: '#ff4d4f' })
              .margin({ right: 10 })
              .onClick(async () => {
                if (this.vm && this.currentNote.authorId) {
                  await this.vm.toggleFollow(this.currentNote.authorId);
                  if (this.followVersion !== undefined) {
                    this.followVersion = this.followVersion + 1;
                  }
                }
              })

            // ÂàÜ‰∫´Âç†‰Ωç
            Text('‚§¥')
              .fontSize(18)
              .padding(10)
          }
          .width('100%')
          .backgroundColor('#ffffff')
          .padding({
            left: 8,
            right: 8,
            top: 24,
            bottom: 8
          })

          // ‰∏ª‰ΩìÔºöÂõæÁâáÂå∫Âüü
          Column() {
            Image(this.getCoverResource())
              .width('100%')
              .height(420)
              .objectFit(ImageFit.Cover)
          }
          .width('100%')
          .height(420)

          // ÊñáÊ°àÂå∫
          Column() {
            Text(this.currentNote.title ?? '')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 6 })

            Text(this.currentNote.content ?? '')
              .fontSize(14)
              .fontColor('#333333')
              .margin({ bottom: 10 })

            // Ê†áÁ≠æÂç†‰Ωç
            Row() {
              Text('#Ê†áÁ≠æ')
                .fontSize(14)
                .fontColor('#2f54eb')
            }
            .margin({ bottom: 10 })

            // Êó∂Èó¥ / Âú∞ÁÇπ
            Row() {
              Text(this.formatDate(this.currentNote.createdAt))
                .fontSize(12)
                .fontColor('#999999')

              Text(' ¬∑ ')
                .fontSize(12)
                .fontColor('#999999')

              Text('ÊµôÊ±ü') // ÂèØ‰ª•‰ªé note ÈáåÂä†Â≠óÊÆµ
                .fontSize(12)
                .fontColor('#999999')

              Blank()

              Text('‰∏çÂñúÊ¨¢')
                .fontSize(12)
                .fontColor('#999999')
                .padding({
                  left: 10,
                  right: 10,
                  top: 6,
                  bottom: 6
                })
                .borderRadius(14)
                .border({ width: 1, color: '#e6e6e6' })
            }
          }
          .width('100%')
          .padding({
            left: 16,
            right: 16,
            top: 14,
            bottom: 16
          })
          .backgroundColor('#ffffff')

          // ËØÑËÆ∫ÂàóË°®ÔºàÂèØÊªöÂä®ÔºåÊòæÁ§∫Êó†ËØÑËÆ∫ÊèêÁ§∫Ôºâ
          Column() {
            Row() {
              Text('ËØÑËÆ∫ (' + this.comments.length + ')')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
            }
            .width('100%')
            .padding({
              left: 16,
              right: 16,
              top: 12,
              bottom: 8
            })

            if (this.comments.length > 0) {
              Column() {
                ForEach(this.comments, (comment: Comment) => {
                  this.buildCommentItem(comment);
                }, (comment: Comment) => comment.id.toString())
              }
              .width('100%')
              .padding({
                left: 16,
                right: 16,
                top: 8,
                bottom: 16
              })
            } else {
              Column() {
                Text('ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•Êä¢Ê≤ôÂèëÂêß~')
                  .fontSize(14)
                  .fontColor('#999999')
                  .padding(20)
              }
              .width('100%')
            }
          }
          .width('100%')
          .backgroundColor('#ffffff')
        }
        .width('100%')
      }
      .layoutWeight(1)

      // Â∫ïÈÉ®Êìç‰ΩúÊ†èÔºàÂõ∫ÂÆöÔºâ
      Row() {
        // ËØÑËÆ∫ËæìÂÖ•Ê°Ü
        Row() {
          TextInput({ placeholder: 'ËØ¥ÁÇπ‰ªÄ‰πà‚Ä¶', text: this.commentInput })
            .onChange((value: string) => {
              this.commentInput = value;
            })
            .onSubmit(async () => {
              await this.submitComment();
            })
            .fontSize(14)
            .backgroundColor('#f2f2f2')
            .borderRadius(20)
            .padding({ left: 12, right: 12 })
            .layoutWeight(1)
            .height(36)

          if (this.commentInput.trim().length > 0) {
            Text('ÂèëÈÄÅ')
              .fontSize(14)
              .fontColor('#ff4d4f')
              .margin({ left: 8 })
              .onClick(async () => {
                await this.submitComment();
              })
          }
        }
        .layoutWeight(1)
        .margin({ right: 8 })

        // Âè≥‰æßÊåâÈíÆÂå∫ÔºöÁÇπËµû/Êî∂Ëóè/ËØÑËÆ∫
        Row() {
          // ÁÇπËµû
          Column() {
            Image($r('app.media.ic_like'))
              .width(20)
              .height(20)
              .fillColor(this.currentNote.liked ? '#ff4d4f' : '#666666')
            Text(this.currentNote.likeCount.toString())
              .fontSize(10)
              .fontColor('#666666')
              .margin({ top: 2 })
          }
          .margin({ right: 12 })
          .onClick(async () => {
            if (this.vm) {
              await this.vm.toggleLike(this.currentNote.id);
              this.currentNote = this.vm.getNote(this.currentNote.id) || this.currentNote;
            }
          })

          // Êî∂Ëóè
          Column() {
            Text(this.currentNote.collected ? '‚òÖ' : '‚òÜ')
              .fontSize(20)
              .fontColor(this.currentNote.collected ? '#ff4d4f' : '#666666')
            Text(this.currentNote.collectCount.toString())
              .fontSize(10)
              .fontColor('#666666')
              .margin({ top: 2 })
          }
          .margin({ right: 12 })
          .onClick(async () => {
            if (this.vm) {
              await this.vm.toggleCollect(this.currentNote.id);
              this.currentNote = this.vm.getNote(this.currentNote.id) || this.currentNote;
            }
          })

          // ËØÑËÆ∫
          Column() {
            Text('üí¨')
              .fontSize(18)
            Text(this.comments.length.toString())
              .fontSize(10)
              .fontColor('#666666')
              .margin({ top: 2 })
          }
          .margin({ right: 6 })
          .onClick(() => {
            // ‰ªÖ‰æõÁÇπÂáªÊó∂ÊªöÂä®ÂõûËØÑËÆ∫Âå∫ÂüüÔºåÂΩìÂâçÁÆÄÂåñ‰∏∫ no-op
          })
        }
        .alignItems(VerticalAlign.Center)
      }
      .width('100%')
      .height(64)
      .padding({
        left: 12,
        right: 12,
        top: 10,
        bottom: 14
      })
      .backgroundColor('#ffffff')
      .shadow({
        radius: 10,
        color: '#22000000',
        offsetX: 0,
        offsetY: -2
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#ffffff')
  }

  private getCoverResource(): Resource {
    if (this.currentNote.coverUri) {
      if (this.currentNote.coverUri.indexOf('note_cover_1') >= 0) {
        return $r('app.media.note_cover_1');
      }
      if (this.currentNote.coverUri.indexOf('note_cover_2') >= 0) {
        return $r('app.media.note_cover_2');
      }
      if (this.currentNote.coverUri.indexOf('note_cover_3') >= 0) {
        return $r('app.media.note_cover_3');
      }
    }
    switch (this.currentNote.coverIndex) {
      case 1:
        return $r('app.media.note_cover_1');
      case 2:
        return $r('app.media.note_cover_2');
      case 3:
      default:
        return $r('app.media.note_cover_3');
    }
  }

  @Builder
  private buildCommentItem(comment: Comment) {
    Row() {
      // Â§¥ÂÉè
      Column() {
        Text(comment.author.charAt(0))
          .fontSize(14)
          .fontColor('#ffffff')
      }
      .width(32)
      .height(32)
      .borderRadius(16)
      .backgroundColor('#ff4d4f')
      .justifyContent(FlexAlign.Center)
      .margin({ right: 12 })

      Column() {
        Row() {
          Text(comment.author)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .margin({ right: 8 })
          Text(comment.content)
            .fontSize(14)
            .fontColor('#333333')
        }
        .width('100%')
        .margin({ bottom: 4 })

        Row() {
          Text(this.formatDate(comment.createdAt))
            .fontSize(12)
            .fontColor('#999999')
          Blank()
          Text('üëç ' + comment.likeCount)
            .fontSize(12)
            .fontColor('#999999')
        }
        .width('100%')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding({ top: 12, bottom: 12 })
    .border({ width: { bottom: 1 }, color: '#f0f0f0' })
  }

  private formatDate(ts: number): string {
    if (!ts) {
      return '';
    }
    const d = new Date(ts);
    const m = d.getMonth() + 1;
    const day = d.getDate();
    const hour = d.getHours();
    const minute = d.getMinutes();
    const now = new Date();
    const diff = now.getTime() - ts;
    const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (diffDays === 0) {
      return `${hour}:${minute.toString().padStart(2, '0')}`;
    } else if (diffDays === 1) {
      return 'Êò®Â§©';
    } else if (diffDays < 7) {
      return `${diffDays}Â§©Ââç`;
    } else {
      return `${m}-${day}`;
    }
  }

  private async submitComment(): Promise<void> {
    if (this.commentInput.trim().length === 0 || !this.vm) {
      return;
    }
    await this.vm.addComment(this.currentNote.id, this.commentInput.trim());
    this.comments = this.vm.getComments(this.currentNote.id);
    this.currentNote = this.vm.getNote(this.currentNote.id) || this.currentNote;
    this.commentInput = '';
    this.showComments = true; // Ëá™Âä®Â±ïÂºÄËØÑËÆ∫ÂàóË°®
  }

  private getAvatarResource(index: number): Resource {
    switch (index) {
      case 1:
        return $r('app.media.head_1');
      case 2:
        return $r('app.media.head_2');
      case 3:
        return $r('app.media.head_3');
      default:
        return $r('app.media.head_1');
    }
  }
}
